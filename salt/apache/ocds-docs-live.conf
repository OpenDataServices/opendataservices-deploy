# vi: ft=apache
<VirtualHost *:80>
    ServerName standard.open-contracting.org
    ServerAlias ocds-standard.*.default.opendataservices.uk0.bigv.io
    ServerAlias *.standard.open-contracting.org
    {% set documentroot='/home/ocds-docs/web/' %}
    DocumentRoot {{ documentroot }}

    <Directory {{ documentroot }}>
        Require all granted
        Options Indexes FollowSymLinks IncludesNOEXEC
        AddOutputFilter INCLUDES .html
        # In a Directory block, so applies only when we'd otherwise be serving local files
        # ie. when not using a proxy
        RedirectMatch ^/(?!robots\.txt)(?!legacy)(?!schema)([^/]+)/?$ /$1/en
    </Directory>
    <Directory {{ documentroot }}legacy/>
        Options +IncludesNOEXEC
        AddOutputFilter INCLUDES .html
    </Directory>
    <Location />
        RedirectMatch ^/$ /latest/
    </Location>

    # This block aplies only to requests that would be proxied to dev
    <Proxy http://ocds-standard.dev3.default.opendataservices.uk0.bigv.io/>
        # Redirects for pages that were on the old
        # standard.open-contracting.org blod site
        Redirect /announcing-the-ocds-help-desk http://www.open-contracting.org/2015/03/20/announcing-the-ocds-help-desk
        Redirect /beta http://www.open-contracting.org/2014/09/04/beta
        Redirect /blog http://www.open-contracting.org/latest-news/
        Redirect /community-web-meeting-exploring-civil-society-contract-monitoring-for-open-contracting-data http://www.open-contracting.org/2014/05/31/community-web-meeting-exploring-civil-society-contract-monitoring-for-open-contracting-data
        Redirect /community-web-meeting-media-use-cases-for-open-contracting-data http://www.open-contracting.org/2014/05/17/community-web-meeting-media-use-cases-for-open-contracting-data
        Redirect /comparing-contract-data-understanding-supply http://www.open-contracting.org/2014/04/30/comparing-contract-data-understanding-supply
        Redirect /contracting-data-comparison-modelling-contracts http://www.open-contracting.org/2014/06/10/contracting-data-comparison-modelling-contracts
        Redirect /contracting-data-comparison-updates http://www.open-contracting.org/2014/05/09/contracting-data-comparison-updates
        Redirect /data-standard-introduction-workshop-in-washington-dc-may-8th-2015 http://www.open-contracting.org/2015/04/14/data-standard-introduction-workshop-in-washington-dc-may-8th-2015
        Redirect /feed http://www.open-contracting.org/feed/
        Redirect /field-notes-transforming-canadian-procurement-data-to-ocds-format http://www.open-contracting.org/2014/09/25/field-notes-transforming-canadian-procurement-data-to-ocds-format
        Redirect /first-release http://www.open-contracting.org/2014/06/27/first-release
        Redirect /getinvolved /latest/en/support
        Redirect /intoduction-to-ocds-workshop-international-open-data-conference-ottawa-may-27th-2015 http://www.open-contracting.org/2015/04/12/intoduction-to-ocds-workshop-international-open-data-conference-ottawa-may-27th-2015
        Redirect /montreal-python-conference-pycon-sprint-what-we-discussed http://www.open-contracting.org/2014/04/19/montreal-python-conference-pycon-sprint-what-we-discussed
        Redirect /montreal-python-conference-pycon-sprint-what-we-worked-on http://www.open-contracting.org/2014/04/20/montreal-python-conference-pycon-sprint-what-we-worked-on
        Redirect /okfest-2014 http://www.open-contracting.org/2014/07/24/okfest-2014
        Redirect /open-contracting-data-standard-at-the-open-government-partnership http://www.open-contracting.org/2015/10/21/open-contracting-data-standard-at-the-open-government-partnership
        Redirect /open-contracting-data-standard-introductory-training http://www.open-contracting.org/2015/07/03/open-contracting-data-standard-introductory-training
        Redirect /open-data-comparison-beta http://www.open-contracting.org/2014/03/04/open-data-comparison-beta
        Redirect /participa /latest/en/support
        Redirect /progress /latest/en/support/history_and_development
        Redirect /project /latest/en
        Redirect /proyecto /latest/en
        Redirect /recursos /latest/en/support/tools
        Redirect /release-of-data-standard http://www.open-contracting.org/2014/11/18/release-of-data-standard
        Redirect /request-for-comments-extending-ocds-for-extractives-industries-and-land http://www.open-contracting.org/2014/12/18/request-for-comments-extending-ocds-for-extractives-industries-and-land
        Redirect /resources /latest/en/support/tools
        Redirect /sprinting-at-europython-2014 http://www.open-contracting.org/2014/07/31/sprinting-at-europython-2014
        Redirect /upgrading-ocds-governance-process-consultation-deadline-january-5th-2016 http://www.open-contracting.org/2015/12/02/upgrading-ocds-governance-process-consultation-deadline-january-5th-2016

        # TODO: remove these once the archive site is removed
        Redirect /author http://archive.standard.open-contracting.org/author
        Redirect /category http://archive.standard.open-contracting.org/category
        Redirect /comments http://archive.standard.open-contracting.org/comments
        Redirect /page http://archive.standard.open-contracting.org/page
        Redirect /wp-content http://archive.standard.open-contracting.org/wp-content
        Redirect /wp-includes http://archive.standard.open-contracting.org/wp-includes
        Redirect /wp-json http://archive.standard.open-contracting.org/wp-json

        RedirectMatch ^/([^/]+)/?$ /$1/en
    </Proxy>

    # With a keepalive we had problems with headers being interpreted as the start of the response.
    SetEnv proxy-nokeepalive 1

    ProxyPass /latest !
    ProxyPass /1.0 !
    ProxyPass /1.1 !
    ProxyPass /legacy !
    ProxyPass /schema !
    ProxyPass /robots.txt !
    ProxyPreserveHost On
    ProxyPass /validator http://cove.cove-live-ocds.default.opendataservices.uk0.bigv.io/validator
    ProxyPass /static http://cove.cove-live-ocds.default.opendataservices.uk0.bigv.io/static
    ProxyPass /media http://cove.cove-live-ocds.default.opendataservices.uk0.bigv.io/media
    ProxyPass /i18n http://cove.cove-live-ocds.default.opendataservices.uk0.bigv.io/i18n
    ProxyPass / http://ocds-standard.dev3.default.opendataservices.uk0.bigv.io/
</VirtualHost>
