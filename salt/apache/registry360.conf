# vi: ft=apache

<VirtualHost *:80>
        {% if servername == 'default' %}
        ServerName data.threesixtygiving.org
        {% else %}
        ServerName {{servername}}
        {% endif %}
        ServerAdmin code@opendataservices.coop
        ServerAlias data.*.live.threesixtygiving.uk0.bigv.io
        ServerAlias {% if branch != pillar.default_branch %}{{ branch }}.{% endif %}registry360.*.default.opendataservices.uk0.bigv.io
        DocumentRoot {{ djangodir }} 

        {{ banner }}

        <Location "/">
                {% if uwsgi_port %}
                ProxyPass uwsgi://127.0.0.1:{{ uwsgi_port }}/
                {% else %}
                ProxyPass unix:/tmp/uwsgi_{{ bare_name }}.sock|http://{{ bare_name }}/
                {% endif %}
        </Location>

        <LocationMatch "/data.json">
                ProxyPass {{ pillar.threesixtygiving.salesforce_api_backend }}
        </LocationMatch>

        {% if pillar.dev_robots_txt %}
        Alias /robots.txt "/var/www/html/robots.txt"
        <Location "/robots.txt">
                ProxyPass !
                Order allow,deny
                Allow from all
                SetHandler None
        </Location>
        {% endif %}

        # Static content needed by Django
        Alias /static "{{ djangodir }}static/"
        <Location "/static">
                ProxyPass !
                Order allow,deny
                Allow from all
                SetHandler None
        </Location>

        # Static content uploaded by users
        Alias /media "{{ djangodir }}media/"
        <Location "/media">
                ProxyPass !
                Order allow,deny
                Allow from all
                SetHandler None
                # Serve json with utf-8 media type
                # https://bugs.chromium.org/p/chromium/issues/detail?id=438464
                # https://github.com/OpenDataServices/cove/issues/478
                AddType "application/json;charset=utf-8" .json
        </Location>

        <Directory {{ djangodir }}>
                Require all granted
        </Directory>
</VirtualHost>
